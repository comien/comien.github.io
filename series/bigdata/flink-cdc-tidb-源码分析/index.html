<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  
    
  <title>FlinkCDC TiDB 源码分析 | 雾雨七辰</title>
  <meta name="author" content="Comien">
  <meta name="description" content="FlinkCDC TiDB 源码分析">
  <meta name="keywords" content="blog,developer,personal">

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="FlinkCDC TiDB 源码分析"/>
<meta name="twitter:description" content="FlinkCDC TiDB 源码分析"/>

  <meta property="og:title" content="FlinkCDC TiDB 源码分析" />
<meta property="og:description" content="FlinkCDC TiDB 源码分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://comien.github.io/series/bigdata/flink-cdc-tidb-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" /><meta property="article:section" content="series" />
<meta property="article:published_time" content="2023-11-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-11-27T00:00:00+00:00" />
<meta property="og:see_also" content="https://comien.github.io/series/bigdata/hadoop-%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4/" />
<meta property="og:see_also" content="https://comien.github.io/series/code-analyse/redis-hash-table/" /><meta property="og:see_also" content="https://comien.github.io/series/code-analyse/redis-sds/" /><meta property="og:see_also" content="https://comien.github.io/series/code-analyse/fifo/" /><meta property="og:see_also" content="https://comien.github.io/series/code-analyse/%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2%E5%8C%BA/" /><meta property="og:see_also" content="https://comien.github.io/series/code-analyse/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/" />



  <link rel="stylesheet" href="/css/bootstrap.min.css"  crossorigin="anonymous">
  
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="/sass/main.css">

  <link rel="stylesheet" href="/zoomjs/zoom.min.css">

  <script src=/js/lazysizes.min.js></script>

  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  

</head>



<body ontouchstart="">
  
  
  <nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://comien.github.io/">雾雨七辰</a>
    </div>
    
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          
          <li><a href="/" title="首页">首页</a></li>
          
          <li><a href="/archive/" title="归档">归档</a></li>
          
          <li><a href="/series/code-analyse" title="源码分析">源码分析</a></li>
          
          <li><a href="/series/bigdata" title="大数据">大数据</a></li>
          
          <li><a href="/about/" title="关于我">关于我</a></li>
          
          <li><a href="https://github.com/comien/" title="Github">Github</a></li>
          

          <li class="search-icon">
            <a href="javascript:void(0)">
              <i class="fa fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
    
  </div>
  
</nav>
<script>
  
  
  
  var $body = document.body;
  var $toggle = document.querySelector(".navbar-toggle");
  var $navbar = document.querySelector("#huxblog_navbar");
  var $collapse = document.querySelector(".navbar-collapse");

  var __HuxNav__ = {
    close: function () {
      $navbar.className = " ";
      
      setTimeout(function () {
        
        if ($navbar.className.indexOf("in") < 0) {
          $collapse.style.height = "0px";
        }
      }, 400);
    },
    open: function () {
      $collapse.style.height = "auto";
      $navbar.className += " in";
    },
  };

  
  $toggle.addEventListener("click", function (e) {
    if ($navbar.className.indexOf("in") > 0) {
      __HuxNav__.close();
    } else {
      __HuxNav__.open();
    }
  });

  

  document.addEventListener("click", function (e) {
    if (e.target == $toggle) return;
    if (e.target.className == "icon-bar") return;
    __HuxNav__.close();
  });
</script>
  
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

  
  


<style type="text/css">
  header.intro-header {
    position: relative;
    background-image: url('');
  }
</style>

<header class="intro-header style-text">

  <div class="header-mask"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags">
            
            <a class="tag" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="大数据">大数据</a>
            
            <a class="tag" href="/tags/flink/" title="Flink">Flink</a>
            
            <a class="tag" href="/tags/flinkcdc/" title="FlinkCDC">FlinkCDC</a>
            
          </div>
          <h1>FlinkCDC TiDB 源码分析</h1>
          <h2 class="subheading"></h2>
          <span class="meta">
            Posted by  雾雨七辰 
            on Mon, Nov 27, 2023
          </span>
        </div>
      </div>
    </div>
  </div>
</header>


  


<article>
  <div class="container">
    <div class="row">

      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              post-container">
        <p>FlinkCDC TiKVRichParallelSourceFunction 算子读取快照数据逻辑分析。</p>
<h2 id="tikvrichparallelsourcefunction-算子快照读取">TiKVRichParallelSourceFunction 算子快照读取<a class="anchorjs-link" href="#tikvrichparallelsourcefunction-%e7%ae%97%e5%ad%90%e5%bf%ab%e7%85%a7%e8%af%bb%e5%8f%96"></a></h2><h3 id="readsnapshotevents">readSnapshotEvents<a class="anchorjs-link" href="#readsnapshotevents"></a></h3><ol>
<li>在算子的 open 函数中，通过传入的 TiDB 配置对象，创建了 TiSession。</li>
<li>然后在读取快照的 <code>readSnapshotEvents</code> 函数通过 session 创建 KVClient，创建 client 用到的 conf 配置就是 session 初始化的 conf。</li>
<li>keyRange 也是在 open 的时候获取的，这里不详细讲解它的源码，只要知道他是<code>当前 task</code> 分配的数据，开始到结束的范围就可以。</li>
<li>在循环中读取 keyRange 数据，读不到数据的时候循环结束，因为 keyRange 是开始到结束，所以这里是读取的表中全部数据。</li>
<li>这里主要看 <code>scanClient.scan</code> 获取数据的源码部分，从 scan 中点进去</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">readSnapshotEvents</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>        LOG.<span style="color:#50fa7b">info</span>(<span style="color:#f1fa8c">&#34;read snapshot events&#34;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>        <span style="color:#ff79c6">try</span> (KVClient scanClient <span style="color:#ff79c6">=</span> session.<span style="color:#50fa7b">createKVClient</span>()) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>            <span style="color:#8be9fd">long</span> startTs <span style="color:#ff79c6">=</span> session.<span style="color:#50fa7b">getTimestamp</span>().<span style="color:#50fa7b">getVersion</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>            ByteString start <span style="color:#ff79c6">=</span> keyRange.<span style="color:#50fa7b">getStart</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>            <span style="color:#ff79c6">while</span> (<span style="color:#ff79c6">true</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                <span style="color:#8be9fd;font-style:italic">final</span> List<span style="color:#ff79c6">&lt;</span>Kvrpcpb.<span style="color:#50fa7b">KvPair</span><span style="color:#ff79c6">&gt;</span> segment <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                        scanClient.<span style="color:#50fa7b">scan</span>(start, keyRange.<span style="color:#50fa7b">getEnd</span>(), startTs);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                <span style="color:#ff79c6">if</span> (segment.<span style="color:#50fa7b">isEmpty</span>()) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                    resolvedTs <span style="color:#ff79c6">=</span> startTs;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                    <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">final</span> Kvrpcpb.<span style="color:#50fa7b">KvPair</span> pair : segment) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                    <span style="color:#ff79c6">if</span> (TableKeyRangeUtils.<span style="color:#50fa7b">isRecordKey</span>(pair.<span style="color:#50fa7b">getKey</span>().<span style="color:#50fa7b">toByteArray</span>())) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                        snapshotEventDeserializationSchema.<span style="color:#50fa7b">deserialize</span>(pair, outputCollector);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>                    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                start <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                        RowKey.<span style="color:#50fa7b">toRawKey</span>(segment.<span style="color:#50fa7b">get</span>(segment.<span style="color:#50fa7b">size</span>() <span style="color:#ff79c6">-</span> 1).<span style="color:#50fa7b">getKey</span>())
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                                .<span style="color:#50fa7b">next</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                                .<span style="color:#50fa7b">toByteString</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    }
</span></span></code></pre></div><h3 id="scanclientscan">scanClient.scan<a class="anchorjs-link" href="#scanclientscan"></a></h3><ol>
<li>点进来可以看到 <code>this.scanIterator</code> 返回迭代器，通过迭代器把数据添加到数组中返回，所以，我们需要看这里迭代器的实现。</li>
<li>点击 <code>scanIterator</code> 进去最终走到 <code>ConcreteScanIterator</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">public</span> List<span style="color:#ff79c6">&lt;</span>Kvrpcpb.<span style="color:#50fa7b">KvPair</span><span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">scan</span>(ByteString startKey, ByteString endKey, <span style="color:#8be9fd">long</span> version) <span style="color:#8be9fd;font-style:italic">throws</span> GrpcException {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>        Iterator<span style="color:#ff79c6">&lt;</span>Kvrpcpb.<span style="color:#50fa7b">KvPair</span><span style="color:#ff79c6">&gt;</span> iterator <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">scanIterator</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">conf</span>, <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">clientBuilder</span>, startKey, endKey, version);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        List<span style="color:#ff79c6">&lt;</span>Kvrpcpb.<span style="color:#50fa7b">KvPair</span><span style="color:#ff79c6">&gt;</span> result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ArrayList();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        iterator.<span style="color:#50fa7b">forEachRemaining</span>(result::add);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>        <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    }
</span></span></code></pre></div><h3 id="concretescaniterator">ConcreteScanIterator<a class="anchorjs-link" href="#concretescaniterator"></a></h3><ol>
<li>进入迭代器后，我们必然需要看的是，<code>hasNext</code> 和 <code>next</code> 的实现</li>
<li>通过 <code>getCurrent</code> 往下分析，可以找到 <code>ScanIterator 中的属性 currentCache</code>，ScanIterator 中并没有对 currentCache 进行初始化，所以这里 getCurrent 返回为 null，所以 haxNext 返回 true</li>
<li>此时 isCacheDrained 返回 true，调用 cacheLoadFails 加载缓存数据，返回 true 的时候，就结束 scan 了，返回 hasNext false</li>
<li>点击查看 cacheLoadFails</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">hasNext</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>        Kvrpcpb.<span style="color:#50fa7b">KvPair</span> current;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>        <span style="color:#ff79c6">do</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>            current <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">getCurrent</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>            <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">isCacheDrained</span>() <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">cacheLoadFails</span>()) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">endOfScan</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        } <span style="color:#ff79c6">while</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> current <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">processingLastBatch</span> <span style="color:#ff79c6">||</span> current <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">hasEndKey</span> <span style="color:#ff79c6">&amp;&amp;</span> Key.<span style="color:#50fa7b">toRawKey</span>(current.<span style="color:#50fa7b">getKey</span>()).<span style="color:#50fa7b">compareTo</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">endKey</span>) <span style="color:#ff79c6">&lt;</span> 0;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> Kvrpcpb.<span style="color:#50fa7b">KvPair</span> <span style="color:#50fa7b">next</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        <span style="color:#ff79c6">--</span><span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">limit</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        Kvrpcpb.<span style="color:#50fa7b">KvPair</span> current <span style="color:#ff79c6">=</span> (Kvrpcpb.<span style="color:#50fa7b">KvPair</span>)<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">get</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">index</span><span style="color:#ff79c6">++</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        Objects.<span style="color:#50fa7b">requireNonNull</span>(current, <span style="color:#f1fa8c">&#34;current kv pair cannot be null&#34;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        <span style="color:#ff79c6">if</span> (current.<span style="color:#50fa7b">hasError</span>()) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>            ByteString val <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">resolveCurrentLock</span>(current);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>            current <span style="color:#ff79c6">=</span> KvPair.<span style="color:#50fa7b">newBuilder</span>().<span style="color:#50fa7b">setKey</span>(current.<span style="color:#50fa7b">getKey</span>()).<span style="color:#50fa7b">setValue</span>(val).<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>        <span style="color:#ff79c6">return</span> current;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>    
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">isCacheDrained</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">limit</span> <span style="color:#ff79c6">&lt;=</span> 0 <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">index</span> <span style="color:#ff79c6">&gt;=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">size</span>() <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">index</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span>1;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> Kvrpcpb.<span style="color:#50fa7b">KvPair</span> <span style="color:#50fa7b">getCurrent</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">isCacheDrained</span>() <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">null</span> : (Kvrpcpb.<span style="color:#50fa7b">KvPair</span>)<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">get</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">index</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>    }
</span></span></code></pre></div><h3 id="scaniteratorcacheloadfails">ScanIterator.cacheLoadFails<a class="anchorjs-link" href="#scaniteratorcacheloadfails"></a></h3><ol>
<li>加载缓存时，先执行了 <code>loadCurrentRegionToCache</code></li>
<li><code>loadCurrentRegionToCache</code> 获取Region，初始化 currentCache，所以在 hasNext 迭代的时候，每次调用 cacheLoadFails，逐步加载所有 Region</li>
<li><code>int scanLimit = Math.min(limit, conf.getScanBatchSize());</code> 计算limit，limit 变量传入的是 Integer.MAX_VALUE，conf.getScanBatchSize 返回固定值 10240，所以 scanLimit 是 10240</li>
<li>如果缓存的数据 &lt; scanLimit，就把缓存数据的结束 key，赋值给 startKey，作为下次加载缓存的开始位</li>
<li>如果缓存的数据 &gt; scanLimit，抛异常</li>
<li>如果相等，通过缓存的最后一个数据，获取它的下一个 key 作为开始位</li>
<li>最后，判断 lastKey &gt;= endKey，设置 startKey 为 null，如果startKey 为空，之后 hasNext 返回 false，结束循环</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">cacheLoadFails</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">endOfScan</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">processingLastBatch</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>            <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">startKey</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>            } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                    TiRegion region <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">loadCurrentRegionToCache</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                    ByteString curRegionEndKey <span style="color:#ff79c6">=</span> region.<span style="color:#50fa7b">getEndKey</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                    } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">index</span> <span style="color:#ff79c6">=</span> 0;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                        Key lastKey <span style="color:#ff79c6">=</span> Key.<span style="color:#50fa7b">EMPTY</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                        <span style="color:#8be9fd">int</span> scanLimit <span style="color:#ff79c6">=</span> Math.<span style="color:#50fa7b">min</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">limit</span>, <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">conf</span>.<span style="color:#50fa7b">getScanBatchSize</span>());
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">size</span>() <span style="color:#ff79c6">&lt;</span> scanLimit) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                            <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">startKey</span> <span style="color:#ff79c6">=</span> curRegionEndKey;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                            lastKey <span style="color:#ff79c6">=</span> Key.<span style="color:#50fa7b">toRawKey</span>(curRegionEndKey);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>                        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                            <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">size</span>() <span style="color:#ff79c6">&gt;</span> scanLimit) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                                <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IndexOutOfBoundsException(<span style="color:#f1fa8c">&#34;current cache size = &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">size</span>() <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;, larger than &#34;</span> <span style="color:#ff79c6">+</span> scanLimit);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                            }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                            lastKey <span style="color:#ff79c6">=</span> Key.<span style="color:#50fa7b">toRawKey</span>(((Kvrpcpb.<span style="color:#50fa7b">KvPair</span>)<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">get</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span>.<span style="color:#50fa7b">size</span>() <span style="color:#ff79c6">-</span> 1)).<span style="color:#50fa7b">getKey</span>());
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                            <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">startKey</span> <span style="color:#ff79c6">=</span> lastKey.<span style="color:#50fa7b">next</span>().<span style="color:#50fa7b">toByteString</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>                        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">hasEndKey</span> <span style="color:#ff79c6">&amp;&amp;</span> lastKey.<span style="color:#50fa7b">compareTo</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">endKey</span>) <span style="color:#ff79c6">&gt;=</span> 0 <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">startKey</span>.<span style="color:#50fa7b">isEmpty</span>()) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>                            <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">processingLastBatch</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>                            <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">startKey</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>                        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>                        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>                    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>                } <span style="color:#ff79c6">catch</span> (Exception var5) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>                    <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> TiClientInternalException(<span style="color:#f1fa8c">&#34;Error scanning data from region.&#34;</span>, var5);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>    }
</span></span></code></pre></div><h3 id="concretescaniteratorloadcurrentregiontocache">ConcreteScanIterator.loadCurrentRegionToCache<a class="anchorjs-link" href="#concretescaniteratorloadcurrentregiontocache"></a></h3><ol>
<li>在这里，调用 RegionStoreClient.scan 初始化了 ScanIterator.currentCache</li>
<li>Region 是 PD 调度 tikv 的基本单位。当数据量超过 Region 阈值 64M，开始分裂</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>TiRegion <span style="color:#50fa7b">loadCurrentRegionToCache</span>() <span style="color:#8be9fd;font-style:italic">throws</span> GrpcException {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>        RegionStoreClient client <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">builder</span>.<span style="color:#50fa7b">build</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">startKey</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>        Throwable var3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        TiRegion var5;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            client.<span style="color:#50fa7b">setTimeout</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">conf</span>.<span style="color:#50fa7b">getScanTimeout</span>());
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            TiRegion region <span style="color:#ff79c6">=</span> client.<span style="color:#50fa7b">getRegion</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>            BackOffer backOffer <span style="color:#ff79c6">=</span> ConcreteBackOffer.<span style="color:#50fa7b">newScannerNextMaxBackOff</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>            <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">currentCache</span> <span style="color:#ff79c6">=</span> client.<span style="color:#50fa7b">scan</span>(backOffer, <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">startKey</span>, <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">version</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>            var5 <span style="color:#ff79c6">=</span> region;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        } <span style="color:#ff79c6">catch</span> (Throwable var14) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            var3 <span style="color:#ff79c6">=</span> var14;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            <span style="color:#ff79c6">throw</span> var14;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        } <span style="color:#ff79c6">finally</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>            <span style="color:#ff79c6">if</span> (client <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                <span style="color:#ff79c6">if</span> (var3 <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>                    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                        client.<span style="color:#50fa7b">close</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                    } <span style="color:#ff79c6">catch</span> (Throwable var13) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                        var3.<span style="color:#50fa7b">addSuppressed</span>(var13);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                    client.<span style="color:#50fa7b">close</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>        <span style="color:#ff79c6">return</span> var5;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>    }
</span></span></code></pre></div>

        <hr style="visibility: hidden;" />
        <ul class="pager">
          
          <li class="previous">
            <a href="/posts/rust/tokio-console/" data-toggle="tooltip" data-placement="top" title="tokio console">
              Previous<br>
              <span>tokio console</span>
            </a>
          </li>
          
          
        </ul>
        <hr style="visibility: hidden;" />

        
        






      </div>

      
      
      
      <div class="
              col-lg-2 col-lg-offset-0
              visible-lg-block
              sidebar-container
              catalog-container">
        <div class="side-catalog">
          <hr class="hidden-sm hidden-xs">
          <h5>
            <a class="catalog-toggle" href="#">CATALOG</a>
          </h5>
          <ul class="catalog-body"></ul>
        </div>
      </div>
      
      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              sidebar-container">

        
        
        <section>
  
  
  <hr class="hidden-sm hidden-xs">
  
  <h5>FEATURED TAGS</h5>
  <div class="tags">
    
    <a href="/tags/c/">c</a>
    
    <a href="/tags/flink/">Flink</a>
    
    <a href="/tags/flinkcdc/">FlinkCDC</a>
    
    <a href="/tags/go-cron/">go-cron</a>
    
    <a href="/tags/go-zero/">go-zero</a>
    
    <a href="/tags/golang/">golang</a>
    
    <a href="/tags/hadoop/">Hadoop</a>
    
    <a href="/tags/index/">index</a>
    
    <a href="/tags/react/">React</a>
    
    <a href="/tags/redis/">redis</a>
    
    <a href="/tags/rust/">rust</a>
    
    <a href="/tags/tauri/">tauri</a>
    
    <a href="/tags/%E5%88%9B%E5%BB%BA%E5%9E%8B/">创建型</a>
    
    <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
    
    <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a>
    
    <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>
    
    <a href="/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
    <a href="/tags/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/">设计原则</a>
    
  </div>
</section>

        
        

<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="" target="_blank"></a></li>
  
  <li><a href="" target="_blank"></a></li>
  
</ul>

      </div>
    </div>
  </div>
</article>



  
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
        <ul class="list-inline text-center">

<li>
  <a href="https://github.com/comien" target="_blank">
    <span class="fa-stack fa-lg">
      <i class="fa fa-circle fa-stack-2x"></i>
      <i class="fab fa-github fa-stack-1x fa-inverse"></i>
    </span>
  </a>
</li>


<li>
  <a href="/index.xml" target="_blank">
    <span class="fa-stack fa-lg">
      <i class="fa fa-circle fa-stack-2x"></i>
      <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
    </span>
  </a>
</li></ul>

        <p class="copyright text-muted">
          Copyright &copy; 雾雨七辰 2023  
          <br>
          Powered by <a href="https://gohugo.io">Hugo</a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js crossorigin="anonymous"></script>



<script src="/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js"></script>


<script src=/js/simple-jekyll-search.min.js></script>


<script src="/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js"></script>






<script type="text/javascript">
  function generateCatalog(selector) {
    _containerSelector = 'div.post-container'
    
    var P = $(_containerSelector), a, n, t, l, i, c;
    a = P.find('h1,h2,h3,h4');
    
    $(selector).html('')
    
    a.each(function () {
      n = $(this).prop('tagName').toLowerCase();
      i = "#" + $(this).prop('id');
      t = $(this).text();
      c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
      l = $('<li class="' + n + '_nav"></li>').append(c);
      $(selector).append(l);
    });
    return true;
  }

  generateCatalog(".catalog-body");

  
  $(".catalog-toggle").click((function (e) {
    e.preventDefault();
    $('.side-catalog').toggleClass("fold")
  }))
</script>


<script type="text/javascript" src='/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js'></script>
<script>
   $(document).ready( function () {
    $('.catalog-body').onePageNav({
      currentClass: "active",
      changeHash: !1,
      easing: "swing",
      filter: "",
      scrollSpeed: 700,
      scrollOffset: 0,
      scrollThreshold: .2,
      begin: null,
      end: null,
      scrollChange: null,
      padding: 80
    });
  });
</script>









<script src="/zoomjs/zoom.min.js"></script>

</body>

</html>